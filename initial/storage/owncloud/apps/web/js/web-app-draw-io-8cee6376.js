define(["./chunks/vendor-569e5121","./chunks/cache-40bfe919","./chunks/useAppDefaults-23e4907b","./chunks/useRoute-1812bd9a","./chunks/resources-a6033be8"],(function(e,t,i,a,s){"use strict";var o={cs:{},de:{"Couldn't save. Error when contacting the server":"Speicher nicht möglich. Fehler beim Kontaktieren des Servers","Diagram imported":"Diagramm importiert","Draw.io document":"Draw.io-Datei","Draw.io editor":"Draw.io Editor","File saved!":"Datei gespeichert!","Loading media":"Lade Daten","Saving error. You're not authorized to save this file":"Speicherfehler. Keine ausreichenden Berechtigungen, um die Datei zu speichern","The diagram could not be loaded…":"Das Diagramm konnte nicht geladen werden...","The diagram will open as a new .drawio file: %{file}":"Das Diagramm wird als neue .drawio Datei geöffnet: %{file}","This file was updated outside this window. Please refresh the page. All changes will be lost, so download a copy first.":"Die Datei wurde außerhalb dieses Fensters aktualisiert. Bitte lade die Seite neu. Alle Änderungen gehen dabei verloren, bitte lade erst eine Kopie herunter."},es:{"Diagram imported":"Diagrama importado","Draw.io editor":"Editor Draw.io","Loading media":"Cargando medios","The diagram could not be loaded…":"El diagrama no puede cargarse ..."},fr:{"Diagram imported":"Diagramme importé","Draw.io editor":"Éditeur Draw.io","Loading media":"Chargement du media","The diagram could not be loaded…":"Le diagramme ne peut pas être chargé..."},gl:{},it:{"Diagram imported":"Diagramma importato","Draw.io document":"Documento Draw.io","Draw.io editor":"Editor Draw.io","File saved!":"File salvato!","Loading media":"Caricamento media","Saving error. You're not authorized to save this file":"Errore di salvataggio. L'utente non è autorizzato a salvare questo file","The diagram could not be loaded…":"Non è stato possibile caricare il diagramma...","The diagram will open as a new .drawio file: %{file}":"Il diagramma verrà aperto come nuovo file .drawio: %{file}"}};const r={name:"DrawIoEditor",setup:()=>({...i.useAppDefaults({applicationName:"draw-io"})}),data:()=>({loading:!0,filePath:"",fileExtension:"",isReadOnly:null,currentETag:null,notificationMessage:null,notificationStatus:null}),computed:{...e.mapGetters(["getToken"]),config(){const{url:e="https://embed.diagrams.net",theme:t="minimal",autosave:i=!1}=this.applicationConfig;return{url:e,theme:t,autosave:i?1:0}},iframeSource(){const t=e.lib.stringify({embed:1,chrome:this.isReadOnly?0:1,picker:0,stealth:1,spin:1,proto:"json",ui:this.config.theme});return`${this.config.url}?${t}`}},created(){this.filePath=this.currentFileContext.path,this.fileExtension=this.filePath.split(".").pop(),this.checkPermissions(),window.addEventListener("message",(e=>{if(e.data.length>0){const t=JSON.parse(e.data);switch(t.event){case"init":"vsdx"===this.fileExtension?this.importVisio():this.load();break;case"autosave":this.save(t,!0);break;case"save":this.save(t);break;case"exit":this.exit()}}}))},methods:{...e.mapActions(["showMessage"]),error(e){this.showMessage({title:this.$gettext("The diagram could not be loaded…"),desc:e,status:"danger"})},errorPopup(e){this.notificationStatus="danger",this.notificationMessage=e},successPopup(e){this.notificationStatus="success",this.notificationMessage=e},clearNotificationMessage(){this.notificationMessage=null},errorNotification(e){this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"status",message:e,modified:!1}),"*")},checkPermissions(){this.getFileInfo(this.filePath,[t.DavProperty.Permissions]).then((e=>{this.isReadOnly=-1===e.fileInfo[t.DavProperty.Permissions].indexOf(t.DavPermission.Updateable),this.loading=!1})).catch((e=>{this.error(e)}))},load(){this.getFileContents(this.filePath,{resolveWithResponseObject:!0}).then((e=>{this.currentETag=e.headers.ETag,this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"load",xml:e.body,autosave:this.config.autosave}),"*")})).catch((e=>{this.error(e)}))},importVisio(){const t=this.getFileUrl(this.filePath),i=new Headers({Authorization:"Bearer "+this.getToken,"X-Requested-With":"XMLHttpRequest"});this.filePath+=`_${this.getTimestamp()}.drawio`,this.showMessage({title:this.$gettext("Diagram imported"),desc:(()=>this.$gettextInterpolate(this.$gettext("The diagram will open as a new .drawio file: %{file}"),{file:e.basename(this.filePath)},!0))()}),fetch(t,{headers:i}).then((e=>e.arrayBuffer())).then((e=>{const t=new Blob([e],{type:"application/vnd.visio"}),i=new FileReader;i.onloadend=()=>{this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"load",xml:i.result,autosave:this.config.autosave}),"*")},i.readAsDataURL(t)})).catch((e=>{this.error(e)}))},save(e,t=!1){this.putFileContents(this.filePath,e.xml,{previousEntityTag:this.currentETag}).then((e=>{this.currentETag=e.ETag;const i=this.$gettext("File saved!");t?this.$refs.drawIoEditor.contentWindow.postMessage(JSON.stringify({action:"status",message:i,modified:!1}),"*"):this.successPopup(i)})).catch((e=>{const i=t?this.errorNotification:this.errorPopup;switch(e.statusCode){case 412:i(this.$gettext("This file was updated outside this window. Please refresh the page. All changes will be lost, so download a copy first."));break;case 500:i(this.$gettext("Couldn't save. Error when contacting the server"));break;case 401:i(this.$gettext("Saving error. You're not authorized to save this file"));break;default:i(e.message||e)}}))},exit(){window.close()},getTimestamp:()=>e.DateTime_1.local().toFormat("YYYYMMDD[T]HHmmss")}};var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("main",[i("oc-notifications",[e.notificationMessage?i("oc-notification-message",{attrs:{message:e.notificationMessage,status:e.notificationStatus},on:{close:e.clearNotificationMessage}}):e._e()],1),e._v(" "),e.loading?i("div",{staticClass:"oc-position-center"},[i("oc-spinner",{attrs:{size:"xlarge"}}),e._v(" "),i("p",{directives:[{name:"translate",rawName:"v-translate"}],staticClass:"oc-invisible"},[e._v("Loading media")])],1):i("iframe",{ref:"drawIoEditor",attrs:{id:"drawio-editor",src:e.iframeSource,title:e.$gettext("Draw.io editor")}})],1)};n._withStripped=!0;return{appInfo:{name:"Draw.io",id:"draw-io",icon:"grid",extensions:[{extension:"drawio",newTab:!0,routeName:"draw-io",newFileMenu:{menuTitle:e=>e("Draw.io document")}},{extension:"vsdx",newTab:!0,routeName:"draw-io"}]},routes:[{name:"draw-io",path:"/:filePath*",component:e.normalizeComponent({render:n,staticRenderFns:[]},undefined,r,"data-v-ccf4ee96",false,undefined,!1,void 0,void 0,void 0),meta:{auth:!1,patchCleanPath:!0}}],translations:o}}));
